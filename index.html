<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TeaPath ‚Äî –ß–∞–π–Ω—ã–π –ø—É—Ç—å</title>
<style>
  /* --- Reset & base --- */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#e8eaed;overflow:hidden}

  /* --- Scene theming --- */
  body.scene-home{background:radial-gradient(1200px 600px at 20% 120%, #0b1018 0,#0b1018 40%,#0a0d14 60%,#070a11 100%),
                                 repeating-linear-gradient(45deg, #0d121a 0 12px,#0b1016 12px 24px)}
  body.scene-street{background:linear-gradient(#0f1e2c,#09121a 40%,#04070c 100%) no-repeat fixed}
  body.scene-dry{background:linear-gradient(180deg,#17120f,#0e0b09)}
  body.scene-grind{background:linear-gradient(180deg,#151414,#0d0c0c)}
  body.scene-ceremony{background:radial-gradient(900px 500px at 80% -20%, #1b2d27 0,#0f1d19 45%,#0a1411 100%)}

  /* Subtle particles (floating dust) */
  .dust{position:fixed;inset:0;pointer-events:none;opacity:.12;background-image:radial-gradient(circle at 10% 20%,#fff 1px,transparent 1px),
                                                      radial-gradient(circle at 80% 30%,#fff 1px,transparent 1px),
                                                      radial-gradient(circle at 30% 60%,#fff 1px,transparent 1px),
                                                      radial-gradient(circle at 60% 80%,#fff 1px,transparent 1px)}
  .dust{animation:fmove 18s linear infinite}
  @keyframes fmove{from{transform:translateY(0)}to{transform:translateY(-30px)}}

  /* --- Layout --- */
  .hud{position:fixed;inset:12px 12px auto 12px;display:flex;gap:10px;align-items:center;z-index:10}
  .badge{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(6px);
         padding:8px 12px;border-radius:12px;display:flex;gap:8px;align-items:center;box-shadow:0 6px 24px rgba(0,0,0,.2)}
  .badge b{font-weight:700}
  .muted{opacity:.75}

  .title{position:fixed;left:50%;top:12px;transform:translateX(-50%);z-index:10;
         background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(8px);
         padding:8px 14px;border-radius:999px;box-shadow:0 6px 24px rgba(0,0,0,.25)}

  .scene{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:20px}
  .card{width:min(980px,100%);min-height:520px;max-height:86vh;display:grid;grid-template-rows:auto 1fr auto;
        background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);border-radius:20px;overflow:hidden;
        box-shadow:0 20px 60px rgba(0,0,0,.35)}

  .card-header,.card-footer{padding:12px 14px;display:flex;align-items:center;justify-content:space-between}
  .card-header{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02))}
  .card-footer{background:linear-gradient(0deg,rgba(255,255,255,.06),rgba(255,255,255,.02))}

  .viewport{position:relative;overflow:hidden}

  /* --- Decorative backgrounds per scene --- */
  .bg{position:absolute;inset:0;pointer-events:none;opacity:.25}
  .bg.tatami{background:
      repeating-linear-gradient(0deg, rgba(255,255,255,.05) 0 2px, transparent 2px 28px),
      repeating-linear-gradient(90deg, rgba(255,255,255,.04) 0 2px, transparent 2px 28px)}
  .bg.street{background:linear-gradient(180deg,transparent 0 60%,rgba(0,0,0,.35) 60% 100%),
             radial-gradient(800px 400px at 50% -10%,rgba(255,255,255,.35),transparent 60%)}
  .bg.wood{background:repeating-linear-gradient(90deg,#201a14 0 22px,#231d16 22px 44px,#1c1712 44px 66px)}
  .bg.tea{background:radial-gradient(600px 320px at 50% 20%,rgba(87,168,125,.25),transparent 60%)}

  /* --- Content layout inside viewport --- */
  .content{position:relative;display:grid;grid-template-columns:1fr 320px;gap:14px;padding:14px}
  .panel{background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:12px;overflow:auto}
  .panel h3{margin:4px 0 8px 0;font-size:16px}

  /* --- Buttons --- */
  .btn{appearance:none;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:#e8eaed;
       padding:10px 12px;border-radius:12px;cursor:pointer;transition:transform .05s ease,background .2s}
  .btn:hover{background:rgba(255,255,255,.14)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:#3aa37b;border-color:#45c08f}
  .btn.warn{background:#9c3a3a;border-color:#b44f4f}
  .btn.ghost{background:transparent}
  .btn:disabled{opacity:.5;cursor:not-allowed}

  /* --- Grid of trees --- */
  .trees{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
  .tree{position:relative;background:rgba(40,60,45,.6);border:1px solid rgba(90,140,110,.5);border-radius:14px;padding:10px;min-height:120px}
  .tree .icon{font-size:38px;filter:drop-shadow(0 6px 12px rgba(0,0,0,.4))}
  .cooldown{height:8px;background:rgba(255,255,255,.1);border-radius:999px;overflow:hidden;margin-top:8px}
  .cooldown .fill{height:100%;background:#59c48f;width:0%}
  .tree .meta{font-size:12px;opacity:.8;margin-top:6px}

  /* --- Progress list --- */
  .list{display:flex;flex-direction:column;gap:8px}
  .job{display:grid;grid-template-columns:1fr 80px;gap:10px;align-items:center;padding:8px;border:1px solid rgba(255,255,255,.12);border-radius:10px;background:rgba(255,255,255,.04)}
  .bar{height:8px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden}
  .bar .f{height:100%;background:#4aa3ff;width:0%}

  /* --- Ceremony visual --- */
  .ceremony-stage{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .teatable{background:rgba(60,45,35,.5);border:1px solid rgba(120,95,75,.6);border-radius:14px;padding:14px;min-height:180px;position:relative}
  .pot{font-size:46px;filter:drop-shadow(0 6px 12px rgba(0,0,0,.45))}
  .steam{position:absolute;left:60px;top:24px;font-size:18px;opacity:0;animation:steam 2s ease-in-out infinite}
  @keyframes steam{0%{transform:translateY(6px);opacity:0}50%{opacity:.9}100%{transform:translateY(-12px);opacity:0}}

  /* --- Nav arrows overlay --- */
  .nav{position:fixed;inset:auto 12px 12px 12px;display:flex;gap:8px;justify-content:space-between;align-items:center;z-index:12}
  .arrow{width:52px;height:52px;border-radius:50%;display:grid;place-items:center;font-size:20px}

  /* --- Small helpers --- */
  .kv{display:flex;gap:8px;align-items:center}
  .kv .k{opacity:.75}
  .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14)}

  /* Scrollbars */
  .panel::-webkit-scrollbar{height:10px;width:10px}
  .panel::-webkit-scrollbar-thumb{background:rgba(255,255,255,.12);border-radius:8px}
</style>
</head>
<body class="scene-home">
  <div class="dust"></div>
  <div class="title">TeaPath ¬∑ –ß–∞–π–Ω—ã–π –ø—É—Ç—å</div>

  <!-- HUD -->
  <div class="hud">
    <div class="badge"><span>üçÉ –õ–∏—Å—Ç—å–µ–≤:</span><b id="inv-leaf">0</b></div>
    <div class="badge"><span>üåø –°—É—à—ë–Ω—ã—Ö:</span><b id="inv-dry">0</b></div>
    <div class="badge"><span>ü´ñ –î—Ä–æ–±–ª—ë–Ω—ã—Ö:</span><b id="inv-crush">0</b></div>
    <div class="badge"><span>üçµ –ß–∞—à–µ–∫:</span><b id="inv-cups">0</b></div>
    <div class="badge muted"><span>üïäÔ∏è –ì–∞—Ä–º–æ–Ω–∏—è:</span><b id="inv-harmony">0</b></div>
    <button class="btn ghost" id="btn-help">‚ùî –ü–æ–º–æ—â—å</button>
    <button class="btn ghost" id="btn-reset">‚Ü∫ –°–±—Ä–æ—Å</button>
  </div>

  <!-- MAIN CARD -->
  <div class="scene">
    <div class="card">
      <div class="card-header">
        <div id="scene-name">–î–æ–º ¬∑ —á–∞–π–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞</div>
        <div class="pill" id="hint">–ù–∞–∂–º–∏ ‚ñ∂ –∏–ª–∏ —Å—Ç—Ä–µ–ª–∫—É –≤–ø—Ä–∞–≤–æ</div>
      </div>

      <div class="viewport">
        <div class="bg tatami" id="bg-tatami" hidden></div>
        <div class="bg street" id="bg-street" hidden></div>
        <div class="bg wood" id="bg-wood" hidden></div>
        <div class="bg tea" id="bg-tea" hidden></div>

        <div class="content" id="content"><!-- filled dynamically --></div>
      </div>

      <div class="card-footer">
        <div class="kv"><div class="k">–õ–æ–∫–∞—Ü–∏–∏:</div><div class="pill">–î–æ–º</div><div class="pill">–£–ª–∏—Ü–∞</div><div class="pill">–°—É—à–∫–∞</div><div class="pill">–î—Ä–æ–±–∏–ª–∫–∞</div><div class="pill">–¶–µ—Ä–µ–º–æ–Ω–∏—è</div></div>
        <div class="kv muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ‚óÄ ‚ñ∂ (–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞) –∏–ª–∏ –∫–Ω–æ–ø–∫–∏ —Å–Ω–∏–∑—É</div>
      </div>
    </div>
  </div>

  <!-- Nav arrows -->
  <div class="nav">
    <button class="btn arrow" id="nav-left">‚óÄ</button>
    <button class="btn arrow" id="nav-right">‚ñ∂</button>
  </div>

<script>
(function(){
  /* =====================
     Core state & helpers
  ======================*/
  const scenes = ['home','street','dry','grind','ceremony'];
  let sceneIndex = 0;
  const now = ()=>Date.now();

  const SAVE_KEY = 'teapath.save.v1';
  const def = {
    inv:{leaf:0, dry:0, crush:0, cups:0, harmony:0},
    // 3 –¥–µ—Ä–µ–≤—Ü–∞ —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º –∫—É–ª–¥–∞—É–Ω–æ–º
    trees:[{readyAt:0},{readyAt:0},{readyAt:0}],
    dryJobs:[], // {id, amount, finishAt}
    grindJobs:[], // {id, amount, finishAt}
    brewJobs:[], // {id, style, finishAt}
    counters:{harvested:0, fed:0}
  };
  let S = load();

  function load(){
    try{ const raw = localStorage.getItem(SAVE_KEY); if(!raw) return structuredClone(def); const obj = JSON.parse(raw); return {...structuredClone(def), ...obj}; }
    catch{ return structuredClone(def); }
  }
  function save(){ localStorage.setItem(SAVE_KEY, JSON.stringify(S)); }

  function fmtTime(ms){ if(ms<=0) return '–≥–æ—Ç–æ–≤–æ'; const s=Math.ceil(ms/1000); const m=Math.floor(s/60), r=s%60; return (m?m+'–º ':'')+r+'—Å'; }

  /* =====================
     Rendering root
  ======================*/
  const content = document.getElementById('content');
  const sceneName = document.getElementById('scene-name');
  const hint = document.getElementById('hint');

  function setScene(i){
    sceneIndex = (i+scenes.length)%scenes.length;
    document.body.className = 'scene-'+scenes[sceneIndex];
    // toggle BG overlays
    document.getElementById('bg-tatami').hidden = scenes[sceneIndex]!=='home' && scenes[sceneIndex]!=='ceremony';
    document.getElementById('bg-street').hidden = scenes[sceneIndex]!=='street';
    document.getElementById('bg-wood').hidden = scenes[sceneIndex]!=='grind' && scenes[sceneIndex]!=='dry';
    document.getElementById('bg-tea').hidden = scenes[sceneIndex]!=='ceremony';
    render();
  }

  function render(){
    // HUD
    invLeaf.textContent = S.inv.leaf;
    invDry.textContent = S.inv.dry;
    invCrush.textContent = S.inv.crush;
    invCups.textContent = S.inv.cups;
    invHarmony.textContent = S.inv.harmony;

    const sc = scenes[sceneIndex];
    if(sc==='home') renderHome();
    if(sc==='street') renderStreet();
    if(sc==='dry') renderDry();
    if(sc==='grind') renderGrind();
    if(sc==='ceremony') renderCeremony();
  }

  /* =====================
     Scene: Home
  ======================*/
  function renderHome(){
    sceneName.textContent = '–î–æ–º ¬∑ —á–∞–π–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞';
    hint.textContent = '–í–ø—Ä–∞–≤–æ ‚Üí –∫ —É–ª–∏—Ü–µ —Å —á–∞–π–Ω—ã–º–∏ –¥–µ—Ä–µ–≤—å—è–º–∏';
    content.innerHTML = `
      <div class="panel" style="grid-column:1/3;min-height:360px;display:grid;place-items:center">
        <div style="text-align:center">
          <div style="font-size:56px;margin-bottom:8px">üèØ</div>
          <div class="muted" style="max-width:560px;margin:0 auto">
            –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –≠—Ç–æ —Ç–≤–æ–π –Ω–µ–±–æ–ª—å—à–æ–π —á–∞–π–Ω—ã–π –¥–æ–º. –û—Ç—Å—é–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ø—É—Ç—å: —Å–æ–±–µ—Ä–∏ –ª–∏—Å—Ç—å—è –Ω–∞ —É–ª–∏—Ü–µ, –≤—ã—Å—É—à–∏ –∏—Ö, —Ä–∞–∑–¥—Ä–æ–±–∏ ‚Äî –∏ –ø—Ä–æ–≤–µ–¥–∏ —á–∞–π–Ω—É—é —Ü–µ—Ä–µ–º–æ–Ω–∏—é.
          </div>
          <div style="margin-top:12px">
            <button class="btn primary" id="go-street">–í–ø–µ—Ä—ë–¥ –∫ –¥–µ—Ä–µ–≤—å—è–º ‚ñ∂</button>
          </div>
        </div>
      </div>`;
    document.getElementById('go-street').onclick=()=>setScene(sceneIndex+1);
  }

  /* =====================
     Scene: Street (Harvest)
  ======================*/
  function renderStreet(){
    sceneName.textContent = '–£–ª–∏—Ü–∞ ¬∑ —á–∞–π–Ω—ã–µ –¥–µ—Ä–µ–≤—å—è';
    hint.textContent = '–ù–∞–∂–∏–º–∞–π –Ω–∞ –¥–µ—Ä–µ–≤—å—è, —á—Ç–æ–±—ã —Å–æ–±–∏—Ä–∞—Ç—å –ª–∏—Å—Ç—å—è';
    const treesHTML = S.trees.map((t,i)=>{
      const cd = Math.max(0, t.readyAt - now());
      const pct = 100 - Math.min(100, Math.floor(cd/15000*100)); // 15 —Å–µ–∫ –∫—É–ª–¥–∞—É–Ω
      return `
        <div class="tree" data-i="${i}">
          <div class="icon">üå≥</div>
          <div class="meta">–î–µ—Ä–µ–≤–æ #${i+1}</div>
          <div class="cooldown"><div class="fill" style="width:${pct}%"></div></div>
          <div class="meta">${cd>0?('—á–µ—Ä–µ–∑ '+fmtTime(cd)):'–≥–æ—Ç–æ–≤–æ –∫ —Å–±–æ—Ä—É'}</div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class="btn harvest" ${cd>0?'disabled':''}>–°–æ–±—Ä–∞—Ç—å üçÉ</button>
          </div>
        </div>`;
    }).join('');

    content.innerHTML = `
      <div class="panel">
        <h3>–°–±–æ—Ä –ª–∏—Å—Ç—å–µ–≤</h3>
        <div class="trees">${treesHTML}</div>
      </div>
      <div class="panel">
        <h3>–ü–æ–¥—Å–∫–∞–∑–∫–∏</h3>
        <div class="list">
          <div>‚Ä¢ –£ –∫–∞–∂–¥–æ–≥–æ –¥–µ—Ä–µ–≤–∞ 15 —Å–µ–∫ –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∏.</div>
          <div>‚Ä¢ –ó–∞ —Å–±–æ—Ä —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å 2‚Äì4 —Å–≤–µ–∂–∏—Ö –ª–∏—Å—Ç–∞.</div>
          <div>‚Ä¢ –ö–æ–≥–¥–∞ –Ω–∞–±–µ—Ä—ë—à—å –ª–∏—Å—Ç—å—è ‚Äî –∏–¥–∏ –≤–ø—Ä–∞–≤–æ –∫ —Å—É—à–∫–µ.</div>
          <div class="muted">–ù–∞–≤–∏–≥–∞—Ü–∏—è: ‚óÄ ‚ñ∂</div>
        </div>
      </div>`;

    content.querySelectorAll('.tree').forEach(card=>{
      const i = Number(card.dataset.i);
      card.querySelector('.harvest').onclick = ()=> harvest(i);
    });
  }
  function harvest(i){
    const t = S.trees[i];
    const cd = Math.max(0, t.readyAt - now());
    if(cd>0) return; // not ready
    const got = 2 + Math.floor(Math.random()*3); // 2..4
    S.inv.leaf += got;
    t.readyAt = now() + 15000; // 15s
    S.counters.harvested++;
    save();
    render();
  }

  /* =====================
     Scene: Dry (Drying racks)
  ======================*/
  const DRY_COST = 5; // —Å–≤–µ–∂–∏—Ö –ª–∏—Å—Ç—å–µ–≤ –∑–∞ –ø–∞—Ä—Ç–∏—é
  const DRY_TIME = 12000; // 12 —Å–µ–∫
  const DRY_YIELD = 3; // —Å—É—à—ë–Ω—ã—Ö

  function renderDry(){
    sceneName.textContent = '–°—É—à–∫–∞ –ª–∏—Å—Ç—å–µ–≤';
    hint.textContent = '–û–±–º–µ–Ω–∏–≤–∞–π —Å–≤–µ–∂–∏–µ –ª–∏—Å—Ç—å—è –Ω–∞ —Å—É—à—ë–Ω—ã–µ (5‚Üí3)';

    const jobs = S.dryJobs.map(job=>{
      const left = Math.max(0, job.finishAt - now());
      const pct = 100 - Math.min(100, Math.floor(left/DRY_TIME*100));
      return `<div class="job"><div>
                <div>–ü–∞—Ä—Ç–∏—è: ${job.amount} üçÉ ‚Üí ${job.amount/DRY_COST*DRY_YIELD} üåø</div>
                <div class="bar"><div class="f" style="width:${pct}%"></div></div>
                <div class="muted">${fmtTime(left)}</div>
              </div>
              <div style="text-align:right">${left<=0?'<button class="btn primary take" data-id="'+job.id+'">–ó–∞–±—Ä–∞—Ç—å</button>':'‚Ä¶'}</div></div>`;
    }).join('') || '<div class="muted">–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞—è</div>';

    content.innerHTML = `
      <div class="panel">
        <h3>–ó–∞–ø—É—Å–∫ —Å—É—à–∫–∏</h3>
        <div class="kv" style="flex-wrap:wrap;gap:10px">
          <div class="pill">–°—Ç–æ–∏–º–æ—Å—Ç—å: <b>${DRY_COST}</b> üçÉ ‚Üí <b>${DRY_YIELD}</b> üåø</div>
          <div class="pill">–í—Ä–µ–º—è: <b>${Math.round(DRY_TIME/1000)}—Å</b></div>
          <button class="btn primary" id="start-dry" ${S.inv.leaf<DRY_COST?'disabled':''}>–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Ç–∏—é</button>
        </div>
      </div>
      <div class="panel">
        <h3>–û—á–µ—Ä–µ–¥—å</h3>
        <div class="list" id="dry-list">${jobs}</div>
      </div>`;

    document.getElementById('start-dry').onclick = ()=>{
      if(S.inv.leaf<DRY_COST) return;
      S.inv.leaf -= DRY_COST;
      S.dryJobs.push({ id: 'd'+Math.random().toString(36).slice(2,8), amount: DRY_COST, finishAt: now()+DRY_TIME });
      save();
      render();
    };

    content.querySelectorAll('.take').forEach(b=>{
      b.onclick = ()=>{
        const id = b.dataset.id;
        const idx = S.dryJobs.findIndex(j=>j.id===id);
        if(idx>=0 && S.dryJobs[idx].finishAt<=now()){
          const batches = S.dryJobs[idx].amount/DRY_COST;
          S.inv.dry += batches*DRY_YIELD;
          S.dryJobs.splice(idx,1);
          save();
          render();
        }
      };
    });
  }

  /* =====================
     Scene: Grind (Crushing)
  ======================*/
  const GRIND_COST = 3; // —Å—É—à—ë–Ω—ã—Ö –∑–∞ –ø–∞—Ä—Ç–∏—é
  const GRIND_TIME = 8000; // 8 —Å–µ–∫
  const GRIND_YIELD = 2; // –¥—Ä–æ–±–ª—ë–Ω—ã—Ö

  function renderGrind(){
    sceneName.textContent = '–î—Ä–æ–±–∏–ª–∫–∞ –ª–∏—Å—Ç—å–µ–≤';
    hint.textContent = '–°—É—à—ë–Ω—ã–µ –ª–∏—Å—Ç—å—è –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ –¥—Ä–æ–±–ª—ë–Ω—ã–µ (3‚Üí2)';

    const jobs = S.grindJobs.map(job=>{
      const left = Math.max(0, job.finishAt - now());
      const pct = 100 - Math.min(100, Math.floor(left/GRIND_TIME*100));
      return `<div class="job"><div>
                <div>–ü–∞—Ä—Ç–∏—è: ${job.amount} üåø ‚Üí ${job.amount/GRIND_COST*GRIND_YIELD} ü´ñ</div>
                <div class="bar"><div class="f" style="width:${pct}%"></div></div>
                <div class="muted">${fmtTime(left)}</div>
              </div>
              <div style="text-align:right">${left<=0?'<button class="btn primary takeg" data-id="'+job.id+'">–ó–∞–±—Ä–∞—Ç—å</button>':'‚Ä¶'}</div></div>`;
    }).join('') || '<div class="muted">–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞—è</div>';

    content.innerHTML = `
      <div class="panel">
        <h3>–ó–∞–ø—É—Å–∫ –¥—Ä–æ–±–ª–µ–Ω–∏—è</h3>
        <div class="kv" style="flex-wrap:wrap;gap:10px">
          <div class="pill">–°—Ç–æ–∏–º–æ—Å—Ç—å: <b>${GRIND_COST}</b> üåø ‚Üí <b>${GRIND_YIELD}</b> ü´ñ</div>
          <div class="pill">–í—Ä–µ–º—è: <b>${Math.round(GRIND_TIME/1000)}—Å</b></div>
          <button class="btn primary" id="start-grind" ${S.inv.dry<GRIND_COST?'disabled':''}>–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Ç–∏—é</button>
        </div>
      </div>
      <div class="panel">
        <h3>–û—á–µ—Ä–µ–¥—å</h3>
        <div class="list" id="grind-list">${jobs}</div>
      </div>`;

    document.getElementById('start-grind').onclick = ()=>{
      if(S.inv.dry<GRIND_COST) return;
      S.inv.dry -= GRIND_COST;
      S.grindJobs.push({ id: 'g'+Math.random().toString(36).slice(2,8), amount: GRIND_COST, finishAt: now()+GRIND_TIME });
      save();
      render();
    };

    content.querySelectorAll('.takeg').forEach(b=>{
      b.onclick = ()=>{
        const id = b.dataset.id;
        const idx = S.grindJobs.findIndex(j=>j.id===id);
        if(idx>=0 && S.grindJobs[idx].finishAt<=now()){
          const batches = S.grindJobs[idx].amount/GRIND_COST;
          S.inv.crush += batches*GRIND_YIELD;
          S.grindJobs.splice(idx,1);
          save();
          render();
        }
      };
    });
  }

  /* =====================
     Scene: Ceremony (Brewing)
  ======================*/
  const BREW_COST = 1; // –¥—Ä–æ–±–ª—ë–Ω—ã—Ö –∑–∞ –∑–∞–≤–∞—Ä–∏–≤–∞–Ω–∏–µ
  const BREW_TIME = 9000; // 9 —Å–µ–∫
  const BREW_YIELD = 2; // —á–∞—à–µ–∫

  function renderCeremony(){
    sceneName.textContent = '–ß–∞–π–Ω–∞—è —Ü–µ—Ä–µ–º–æ–Ω–∏—è';
    hint.textContent = '–í—ã–±–µ—Ä–∏ —Å—Ç–∏–ª—å –∏ –∑–∞–≤–∞—Ä–∏–º —á–∞–π (1ü´ñ ‚Üí 2üçµ)';

    const jobs = S.brewJobs.map(job=>{
      const left = Math.max(0, job.finishAt - now());
      const pct = 100 - Math.min(100, Math.floor(left/BREW_TIME*100));
      return `<div class="job"><div>
                <div>–ó–∞–≤–∞—Ä–∏–≤–∞–Ω–∏–µ: —Å—Ç–∏–ª—å <b>${job.style}</b></div>
                <div class="bar"><div class="f" style="width:${pct}%"></div></div>
                <div class="muted">${fmtTime(left)}</div>
              </div>
              <div style="text-align:right">${left<=0?'<button class="btn primary takeb" data-id="'+job.id+'">–ü–æ–¥–∞—Ç—å</button>':'‚Ä¶'}</div></div>`;
    }).join('') || '<div class="muted">–ß–∞–π–Ω–∏–∫ –ø—É—Å—Ç üôÇ</div>';

    content.innerHTML = `
      <div class="panel">
        <h3>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</h3>
        <div class="ceremony-stage">
          <div class="teatable">
            <div style="display:flex;align-items:center;gap:10px"><div class="pot">ü´ñ</div><div>
              <div class="pill" style="margin-bottom:8px">–°—Ç–æ–∏–º–æ—Å—Ç—å: <b>${BREW_COST}</b> ü´ñ ‚Üí <b>${BREW_YIELD}</b> üçµ</div>
              <div class="kv" style="gap:10px;flex-wrap:wrap">
                <select id="style" class="btn">
                  <option value="—Å–µ–Ω—á–∞">–°–µ–Ω—á–∞</option>
                  <option value="—É–ª—É–Ω">–£–ª—É–Ω</option>
                  <option value="—á—ë—Ä–Ω—ã–π">–ß—ë—Ä–Ω—ã–π</option>
                </select>
                <button class="btn primary" id="start-brew" ${S.inv.crush<BREW_COST?'disabled':''}>–ó–∞–≤–∞—Ä–∏—Ç—å</button>
              </div>
            </div></div>
            <div class="steam">‚ô®Ô∏è</div>
          </div>
          <div class="panel">
            <h3>–¢—Ä–∞–¥–∏—Ü–∏—è</h3>
            <div class="list">
              <div>‚Ä¢ –ù–∞–≥—Ä–µ–π —á–∞–π–Ω–∏–∫ –∏ –ø–∏–∞–ª—ã.</div>
              <div>‚Ä¢ –ü—Ä–æ–º–æ–π –ª–∏—Å—Ç—å—è –≥–æ—Ä—è—á–µ–π –≤–æ–¥–æ–π.</div>
              <div>‚Ä¢ –ö–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–æ–ª–∏–≤—ã ‚Äî –º—è–≥–∫–∏–π –≤–∫—É—Å ‚ò∫Ô∏è</div>
            </div>
          </div>
        </div>
      </div>
      <div class="panel">
        <h3>–ß–∞–π–Ω–∏–∫</h3>
        <div class="list" id="brew-list">${jobs}</div>
      </div>`;

    const steam = content.querySelector('.steam');
    let steamTimer=null;
    document.getElementById('start-brew').onclick = ()=>{
      if(S.inv.crush<BREW_COST) return;
      S.inv.crush -= BREW_COST;
      const style = document.getElementById('style').value;
      S.brewJobs.push({ id: 'b'+Math.random().toString(36).slice(2,8), style, finishAt: now()+BREW_TIME });
      save();
      render();
      steam.style.opacity=1; clearTimeout(steamTimer); steamTimer=setTimeout(()=>steam.style.opacity=0, 3000);
    };

    content.querySelectorAll('.takeb').forEach(b=>{
      b.onclick = ()=>{
        const id = b.dataset.id;
        const idx = S.brewJobs.findIndex(j=>j.id===id);
        if(idx>=0 && S.brewJobs[idx].finishAt<=now()){
          S.inv.cups += BREW_YIELD;
          S.inv.harmony += 1; // —á—É—Ç—å-—á—É—Ç—å –≥–∞—Ä–º–æ–Ω–∏–∏ –∑–∞ –∫–∞–∂–¥—É—é –ø–æ–¥–∞—á—É
          S.brewJobs.splice(idx,1);
          save();
          render();
        }
      };
    });
  }

  /* =====================
     UI Wiring
  ======================*/
  const invLeaf = document.getElementById('inv-leaf');
  const invDry = document.getElementById('inv-dry');
  const invCrush = document.getElementById('inv-crush');
  const invCups = document.getElementById('inv-cups');
  const invHarmony = document.getElementById('inv-harmony');

  document.getElementById('nav-left').onclick = ()=> setScene(sceneIndex-1);
  document.getElementById('nav-right').onclick = ()=> setScene(sceneIndex+1);
  window.addEventListener('keydown', (e)=>{
    if(e.key==='ArrowRight') setScene(sceneIndex+1);
    if(e.key==='ArrowLeft') setScene(sceneIndex-1);
  });

  document.getElementById('btn-help').onclick = ()=>{
    alert('–¶–µ–ª—å: –ø—Ä–æ–π—Ç–∏ –ø—É—Ç—å –æ—Ç –ª–∏—Å—Ç—å–µ–≤ –¥–æ —á–∞–π–Ω–æ–π —Ü–µ—Ä–µ–º–æ–Ω–∏–∏.\n\n‚Üí –£–ª–∏—Ü–∞: —Å–æ–±–∏—Ä–∞–π üçÉ —Å –¥–µ—Ä–µ–≤—å–µ–≤ (–∫—É–ª–¥–∞—É–Ω 15—Å).\n‚Üí –°—É—à–∫–∞: 5 üçÉ ‚Üí 3 üåø –∑–∞ ~12—Å.\n‚Üí –î—Ä–æ–±–∏–ª–∫–∞: 3 üåø ‚Üí 2 ü´ñ –∑–∞ ~8—Å.\n‚Üí –¶–µ—Ä–µ–º–æ–Ω–∏—è: 1 ü´ñ ‚Üí 2 üçµ –∑–∞ ~9—Å (–∏ +1 –≥–∞—Ä–º–æ–Ω–∏–∏).\n\n–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –£–¥–∞—á–∏!');
  };
  document.getElementById('btn-reset').onclick = ()=>{
    if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')){ S = structuredClone(def); save(); setScene(0); }
  };

  // small ticker for progress bars
  setInterval(()=>{ render(); }, 500);

  // Auto show first scene
  setScene(0);
})();
</script>
</body>
</html>
